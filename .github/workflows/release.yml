
on:
  release:
    types: [created]
  workflow_dispatch:

jobs:
  release:
    name: release ${{ matrix.target }}
    runs-on: ${{ matrix.os }}
    permissions:
      contents: write
    strategy:
      fail-fast: false
      matrix:
        include:
          - os: windows-latest
            target: x86_64-pc-windows-gnu
            archive: zip
          - os: ubuntu-latest
            target: x86_64-unknown-linux-musl
            archive: tar.gz tar.xz tar.zst
    steps:
      - uses: actions/checkout@master
      - name: Install Msquic
        run: vcpkg install msquic
      
      - uses: actions-rust-lang/setup-rust-toolchain@v1
        with:
          components: rustfmt
          toolchain: "1.75"
          target: ${{ matrix.target }}
          
      - name: Rustfmt Check
        uses: actions-rust-lang/rustfmt@v1
        
      - name: Build and Test
        run: |
          cargo build --release --target ${{ matrix.target }}
          cargo test --release --target ${{ matrix.target }}

      - name: Set artifact binary path
        shell: bash
        run: |
          bin_name="msquic-echo-rs"
          bin_ext=""
          if [[ "${{ matrix.target }}" == *windows* ]]; then
            bin_ext=".exe"
          fi
          echo "BIN_PATH=target/${{ matrix.target }}/release/${bin_name}${bin_ext}" >> "$GITHUB_ENV"

      - name: Upload binary artifact
        uses: actions/upload-artifact@v4
        with:
          name: ${{ github.event.repository.name }}-${{ matrix.target }}
          path: ${{ env.BIN_PATH }}

      - name: Prepare release asset
        if: github.event_name == 'release'
        shell: bash
        run: |
          mkdir -p dist
          asset_name="${{ github.event.repository.name }}-${{ matrix.target }}$( [[ "${{ matrix.target }}" == *windows* ]] && echo ".exe" || true )"
          cp "${{ env.BIN_PATH }}" "dist/${asset_name}"
          echo "ASSET_PATH=dist/${asset_name}" >> "$GITHUB_ENV"

      - name: Upload binary to GitHub Release
        if: github.event_name == 'release'
        uses: softprops/action-gh-release@v2
        with:
          files: ${{ env.ASSET_PATH }}
          fail_on_unmatched_files: true
