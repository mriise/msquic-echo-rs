
on:
  release:
    types: [created]
  workflow_dispatch:

jobs:
  release:
    name: release ${{ matrix.target }}
    runs-on: ${{ matrix.os }}
    permissions:
      contents: write
    env:
      VCPKG_ROOT: ${{ matrix.vcpkg_root }}
    strategy:
      fail-fast: false
      matrix:
        include:
          - os: windows-latest
            target: x86_64-pc-windows-gnu
            archive: zip
            vcpkg_root: 'C:\vcpkg'
            vcpkg_triplet: x64-windows
          - os: ubuntu-latest
            target: x86_64-unknown-linux-musl
            archive: tar.gz tar.xz tar.zst
            vcpkg_root: /usr/local/share/vcpkg
            vcpkg_triplet: x64-linux
    steps:
      - uses: actions/checkout@master
      - name: Ensure vcpkg cache directory
        shell: pwsh
        env:
          VCPKG_DEFAULT_BINARY_CACHE: ${{ runner.temp }}/vcpkg-binary-cache
        run: |
          $path = "$env:VCPKG_DEFAULT_BINARY_CACHE"
          if (!(Test-Path -LiteralPath $path)) {
            New-Item -ItemType Directory -Path $path -Force | Out-Null
          }

      - name: Cache vcpkg artifacts
        uses: actions/cache@v4
        with:
          path: ${{ runner.temp }}/vcpkg-binary-cache
          key: vcpkg-${{ runner.os }}-${{ matrix.target }}-msquic-${{ hashFiles('**/vcpkg*.json') }}
          restore-keys: |
            vcpkg-${{ runner.os }}-${{ matrix.target }}-msquic-
            vcpkg-${{ runner.os }}-msquic-

      - name: Install Msquic
        env:
          VCPKG_DEFAULT_BINARY_CACHE: ${{ runner.temp }}/vcpkg-binary-cache
          VCPKG_BINARY_SOURCES: 'clear;files,${{ runner.temp }}/vcpkg-binary-cache,readwrite'
          VCPKG_ROOT: ${{ matrix.vcpkg_root }}
          VCPKG_DEFAULT_TRIPLET: ${{ matrix.vcpkg_triplet }}
          VCPKG_TARGET_TRIPLET: ${{ matrix.vcpkg_triplet }}
        run: vcpkg install msquic --triplet ${{ matrix.vcpkg_triplet }}

      - name: Make msquic available for build script (Linux)
        if: runner.os == 'Linux'
        shell: bash
        run: |
          libdir="${VCPKG_ROOT}/installed/x64-linux/lib"
          sudo mkdir -p /usr/lib/x86_64-linux-gnu
          sudo cp -f ${libdir}/libmsquic.so* /usr/lib/x86_64-linux-gnu/
          ls -l /usr/lib/x86_64-linux-gnu/libmsquic.so*

      - name: Make msquic available for build script (Windows)
        if: runner.os == 'Windows'
        shell: pwsh
        run: |
          $libdir = Join-Path $env:VCPKG_ROOT "installed\\${{ matrix.vcpkg_triplet }}\\lib"
          $bindir = Join-Path $env:VCPKG_ROOT "installed\\${{ matrix.vcpkg_triplet }}\\bin"
          if (-not (Test-Path $libdir)) { throw "msquic lib directory missing: $libdir" }
          if (-not (Test-Path $bindir)) { throw "msquic bin directory missing: $bindir" }
          Get-ChildItem $libdir
          Get-ChildItem $bindir
      
      - uses: actions-rust-lang/setup-rust-toolchain@v1
        with:
          components: rustfmt
          toolchain: "1.75"
          target: ${{ matrix.target }}
          
      - name: Rustfmt Check
        uses: actions-rust-lang/rustfmt@v1
        
      - name: Build and Test
        env:
          VCPKG_ROOT: ${{ matrix.vcpkg_root }}
        run: |
          cargo build --release --target ${{ matrix.target }}
          cargo test --release --target ${{ matrix.target }}

      - name: Set artifact binary path
        shell: bash
        run: |
          bin_name="msquic-echo-rs"
          bin_ext=""
          if [[ "${{ matrix.target }}" == *windows* ]]; then
            bin_ext=".exe"
          fi
          echo "BIN_PATH=target/${{ matrix.target }}/release/${bin_name}${bin_ext}" >> "$GITHUB_ENV"

      - name: Upload binary artifact
        uses: actions/upload-artifact@v4
        with:
          name: ${{ github.event.repository.name }}-${{ matrix.target }}
          path: ${{ env.BIN_PATH }}

      - name: Prepare release asset
        if: github.event_name == 'release'
        shell: bash
        run: |
          mkdir -p dist
          asset_name="${{ github.event.repository.name }}-${{ matrix.target }}$( [[ "${{ matrix.target }}" == *windows* ]] && echo ".exe" || true )"
          cp "${{ env.BIN_PATH }}" "dist/${asset_name}"
          echo "ASSET_PATH=dist/${asset_name}" >> "$GITHUB_ENV"

      - name: Upload binary to GitHub Release
        if: github.event_name == 'release'
        uses: softprops/action-gh-release@v2
        with:
          files: ${{ env.ASSET_PATH }}
          fail_on_unmatched_files: true
